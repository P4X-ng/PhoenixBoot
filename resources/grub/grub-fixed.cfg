# PhoenixGuard GRUB Configuration - PRODUCTION FIXED
set timeout=5
set default=0
set gfxmode=auto
set gfxpayload=keep

insmod efi_gop
insmod efi_uga
insmod font
insmod part_gpt
insmod fat
insmod ext2
insmod normal

# Boot from ESP partition (wherever it's mounted)
menuentry "PhoenixGuard Secure Boot" {
    # Search for our ESP by file signature
    search --no-floppy --file /EFI/PhoenixGuard/BUILD_UUID.txt --set=esp
    if [ -z "$esp" ]; then
        echo "ERROR: PhoenixGuard ESP not found!"
        echo "Looking for /EFI/PhoenixGuard/BUILD_UUID.txt"
        sleep 5
    else
        chainloader ($esp)/EFI/PhoenixGuard/BootX64.efi
    fi
}

# Recovery kernel from ESP (if present)
menuentry "PhoenixGuard Recovery Mode" {
    search --no-floppy --file /recovery/vmlinuz --set=esp
    if [ -z "$esp" ]; then
        echo "ERROR: Recovery kernel not found on ESP"
        sleep 3
    else
        linux ($esp)/recovery/vmlinuz root=/dev/ram0 rw quiet
        if [ -f ($esp)/recovery/initrd.img ]; then
            initrd ($esp)/recovery/initrd.img
        fi
    fi
}

# Boot from external ISO (USB/CD)
menuentry "Boot from External ISO/USB" {
    # Look for ISOs on OTHER devices, not in ESP
    search --no-floppy --file /PhoenixGuard-Recovery.iso --set=isodev
    if [ -z "$isodev" ]; then
        echo "Insert PhoenixGuard Recovery USB/CD and try again"
        sleep 3
    else
        set isofile="/PhoenixGuard-Recovery.iso"
        loopback loop ($isodev)$isofile
        linux (loop)/casper/vmlinuz boot=casper iso-scan/filename=$isofile toram ---
        initrd (loop)/casper/initrd
    fi
}

# Fallback to normal boot
menuentry "Boot Installed OS" {
    # Try to find and boot the main OS
    search --no-floppy --fs-uuid --set=root ${INSTALLED_ROOT_UUID}
    if [ -z "$root" ]; then
        # Fallback: search for grub.cfg on any partition
        search --no-floppy --file /boot/grub/grub.cfg --set=root
    fi
    configfile /boot/grub/grub.cfg
}

menuentry "UEFI Firmware Settings" {
    fwsetup
}

menuentry "Reboot" {
    reboot
}

menuentry "Power Off" {
    halt
}
