00000000: 2321 2f75 7372 2f62 696e 2f65 6e76 2062  #!/usr/bin/env b
00000010: 6173 680a 2320 4465 7363 7269 7074 696f  ash.# Descriptio
00000020: 6e3a 2047 656e 6572 6174 6573 2053 6563  n: Generates Sec
00000030: 7572 6520 426f 6f74 206b 6579 7061 6972  ure Boot keypair
00000040: 7320 2850 4b2c 204b 454b 2c20 6462 292e  s (PK, KEK, db).
00000050: 0a0a 7365 7420 2d65 756f 2070 6970 6566  ..set -euo pipef
00000060: 6169 6c0a 0a23 2050 4b0a 5b20 2d66 206b  ail..# PK.[ -f k
00000070: 6579 732f 504b 2e6b 6579 205d 207c 7c20  eys/PK.key ] || 
00000080: 6f70 656e 7373 6c20 7265 7120 2d6e 6577  openssl req -new
00000090: 202d 7835 3039 202d 6e65 776b 6579 2072   -x509 -newkey r
000000a0: 7361 3a34 3039 3620 2d6e 6f64 6573 202d  sa:4096 -nodes -
000000b0: 7368 6132 3536 202d 6461 7973 2033 3635  sha256 -days 365
000000c0: 3020 5c0a 2020 2020 2d73 7562 6a20 222f  0 \.    -subj "/
000000d0: 434e 3d50 686f 656e 6978 4775 6172 6420  CN=PhoenixGuard 
000000e0: 504b 2f4f 3d50 686f 656e 6978 4775 6172  PK/O=PhoenixGuar
000000f0: 642f 433d 5553 2220 2d6b 6579 6f75 7420  d/C=US" -keyout 
00000100: 6b65 7973 2f50 4b2e 6b65 7920 2d6f 7574  keys/PK.key -out
00000110: 206b 6579 732f 504b 2e63 7274 0a6f 7065   keys/PK.crt.ope
00000120: 6e73 736c 2078 3530 3920 2d69 6e20 6b65  nssl x509 -in ke
00000130: 7973 2f50 4b2e 6372 7420 2d6f 7574 666f  ys/PK.crt -outfo
00000140: 726d 2044 4552 202d 6f75 7420 6b65 7973  rm DER -out keys
00000150: 2f50 4b2e 6365 720a 6368 6d6f 6420 3630  /PK.cer.chmod 60
00000160: 3020 6b65 7973 2f50 4b2e 6b65 7920 7c7c  0 keys/PK.key ||
00000170: 2074 7275 650a 0a23 204b 454b 0a5b 202d   true..# KEK.[ -
00000180: 6620 6b65 7973 2f4b 454b 2e6b 6579 205d  f keys/KEK.key ]
00000190: 207c 7c20 6f70 656e 7373 6c20 7265 7120   || openssl req 
000001a0: 2d6e 6577 202d 7835 3039 202d 6e65 776b  -new -x509 -newk
000001b0: 6579 2072 7361 3a34 3039 3620 2d6e 6f64  ey rsa:4096 -nod
000001c0: 6573 202d 7368 6132 3536 202d 6461 7973  es -sha256 -days
000001d0: 2033 3635 3020 5c0a 2020 2020 2d73 7562   3650 \.    -sub
000001e0: 6a20 222f 434e 3d50 686f 656e 6978 4775  j "/CN=PhoenixGu
000001f0: 6172 6420 4b45 4b2f 4f3d 5068 6f65 6e69  ard KEK/O=Phoeni
00000200: 7847 7561 7264 2f43 3d55 5322 202d 6b65  xGuard/C=US" -ke
00000210: 796f 7574 206b 6579 732f 4b45 4b2e 6b65  yout keys/KEK.ke
00000220: 7920 2d6f 7574 206b 6579 732f 4b45 4b2e  y -out keys/KEK.
00000230: 6372 740a 6f70 656e 7373 6c20 7835 3039  crt.openssl x509
00000240: 202d 696e 206b 6579 732f 4b45 4b2e 6372   -in keys/KEK.cr
00000250: 7420 2d6f 7574 666f 726d 2044 4552 202d  t -outform DER -
00000260: 6f75 7420 6b65 7973 2f4b 454b 2e63 6572  out keys/KEK.cer
00000270: 0a63 686d 6f64 2036 3030 206b 6579 732f  .chmod 600 keys/
00000280: 4b45 4b2e 6b65 7920 7c7c 2074 7275 650a  KEK.key || true.
00000290: 0a23 2064 620a 5b20 2d66 206b 6579 732f  .# db.[ -f keys/
000002a0: 6462 2e6b 6579 205d 207c 7c20 6f70 656e  db.key ] || open
000002b0: 7373 6c20 7265 7120 2d6e 6577 202d 7835  ssl req -new -x5
000002c0: 3039 202d 6e65 776b 6579 2072 7361 3a34  09 -newkey rsa:4
000002d0: 3039 3620 2d6e 6f64 6573 202d 7368 6132  096 -nodes -sha2
000002e0: 3536 202d 6461 7973 2033 3635 3020 5c0a  56 -days 3650 \.
000002f0: 2020 2020 2d73 7562 6a20 222f 434e 3d50      -subj "/CN=P
00000300: 686f 656e 6978 4775 6172 6420 6462 2f4f  hoenixGuard db/O
00000310: 3d50 686f 656e 6978 4775 6172 642f 433d  =PhoenixGuard/C=
00000320: 5553 2220 2d6b 6579 6f75 7420 6b65 7973  US" -keyout keys
00000330: 2f64 622e 6b65 7920 2d6f 7574 206b 6579  /db.key -out key
00000340: 732f 6462 2e63 7274 0a6f 7065 6e73 736c  s/db.crt.openssl
00000350: 2078 3530 3920 2d69 6e20 6b65 7973 2f64   x509 -in keys/d
00000360: 622e 6372 7420 2d6f 7574 666f 726d 2044  b.crt -outform D
00000370: 4552 202d 6f75 7420 6b65 7973 2f64 622e  ER -out keys/db.
00000380: 6365 720a 6368 6d6f 6420 3630 3020 6b65  cer.chmod 600 ke
00000390: 7973 2f64 622e 6b65 7920 7c7c 2074 7275  ys/db.key || tru
000003a0: 650a 0a65 6368 6f20 22e2 9c85 204b 6579  e..echo "... Key
000003b0: 7320 616e 6420 6365 7274 7320 696e 202e  s and certs in .
000003c0: 2f6b 6579 7322 0a0a                      /keys"..
