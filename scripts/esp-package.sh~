#!/usr/bin/env bash
set -euo pipefail
cd "$(dirname "$0")/.."
source scripts/lib/common.sh

info "ðŸ“¦ Creating bootable ESP image..."
require_cmd dd
require_cmd mkfs.fat

ensure_dir out/esp
unmount_if_mounted out/esp/mount

detach_loops_for_image out/esp/esp.img

[ -f out/staging/BootX64.efi ] || die "No BootX64.efi found - run 'just build' first"

ESP_MB=${ESP_MB:-64}
if [ -n "${ISO_PATH:-}" ] && [ -f "${ISO_PATH}" ]; then
  ISO_BYTES=$(stat -c%s "${ISO_PATH}" 2>/dev/null || stat -f%z "${ISO_PATH}" 2>/dev/null || echo 0)
  ISO_MB=$(( (ISO_BYTES + 1048575) / 1048576 ))
  [ "$ISO_MB" -lt 64 ] && ISO_MB=64
  OVERHEAD_MB=${OVERHEAD_MB:-512}
  ESP_MB=$(( ISO_MB + OVERHEAD_MB ))
  info "Sizing ESP to ${ESP_MB} MiB for ISO inclusion (${ISO_MB} MiB ISO + ${OVERHEAD_MB} MiB overhead)"
fi

# Create image and FS
rm -f out/esp/esp.img
dd if=/dev/zero of=out/esp/esp.img bs=1M count=${ESP_MB}
mkfs.fat -F32 out/esp/esp.img

# Mount rw
ensure_dir out/esp/mount
mount_rw_loop out/esp/esp.img out/esp/mount

# Layout
sudo mkdir -p out/esp/mount/EFI/BOOT
sudo mkdir -p out/esp/mount/EFI/PhoenixGuard
sudo mkdir -p out/esp/mount/boot/grub

# Copy bootloader(s)
sudo cp out/staging/BootX64.efi out/esp/mount/EFI/BOOT/BOOTX64.EFI
[ -f out/staging/KeyEnrollEdk2.efi ] && sudo cp out/staging/KeyEnrollEdk2.efi out/esp/mount/EFI/BOOT/

# Optional GRUB fragment
if [ -f staging/config/grub/user.cfg ]; then
  ok "Including user.cfg from staging/config/grub/user.cfg"
  sudo install -D -m0644 staging/config/grub/user.cfg out/esp/mount/EFI/PhoenixGuard/user.cfg
fi

# Try to include shim and grub
GRUB_SRC=""; SHIM_SRC=""
for cand in \
  "/usr/lib/grub/x86_64-efi-signed/grubx64.efi.signed" \
  "/usr/lib/grub/x86_64-efi/grubx64.efi" \
  "/boot/efi/EFI/ubuntu/grubx64.efi" \
  "/boot/efi/EFI/Boot/grubx64.efi"; do
  [ -f "$cand" ] && GRUB_SRC="$cand" && break || true
done
for cand in \
  "/usr/lib/shim/shimx64.efi.signed" \
  "/usr/lib/shim/shimx64.efi" \
  "/boot/efi/EFI/ubuntu/shimx64.efi"; do
  [ -f "$cand" ] && SHIM_SRC="$cand" && break || true
done
if [ -n "$GRUB_SRC" ]; then
  ok "Found grub at $GRUB_SRC"
  sudo cp "$GRUB_SRC" out/esp/mount/EFI/PhoenixGuard/grubx64.efi
else
  warn "grubx64.efi not found on host; Clean GRUB Boot will skip grub"
fi
if [ -n "$SHIM_SRC" ]; then
  ok "Found shim at $SHIM_SRC"
  sudo cp "$SHIM_SRC" out/esp/mount/EFI/PhoenixGuard/shimx64.efi
else
  info "shimx64.efi not found on host; will attempt direct GRUB chainload"
fi

# Minimal GRUB modules (best-effort)
sudo mkdir -p out/esp/mount/boot/grub/x86_64-efi
for mod in part_gpt fat iso9660 loopback normal linux efi_gop efi_uga search regexp test ls gzio; do
  [ -f "/usr/lib/grub/x86_64-efi/${mod}.mod" ] && sudo cp "/usr/lib/grub/x86_64-efi/${mod}.mod" out/esp/mount/boot/grub/x86_64-efi/ || true
done

# Optional ISO
ISO_BASENAME=""; ISO_EXTRA_ARGS="${ISO_EXTRA_ARGS:-}"
if [ -n "${ISO_PATH:-}" ] && [ -f "${ISO_PATH}" ]; then
  ISO_BASENAME=$(basename "${ISO_PATH}")
  ok "Including ISO: ${ISO_PATH}"
  sudo mkdir -p out/esp/mount/ISO
  sudo cp "${ISO_PATH}" "out/esp/mount/ISO/${ISO_BASENAME}"
fi

# Build UUID and sidecar
HASH=$(sha256_file out/staging/BootX64.efi)
BUILD_UUID=${BUILD_UUID:-${HASH:0:8}-${HASH:8:4}-${HASH:12:4}-${HASH:16:4}-${HASH:20:12}}
printf '%s\n' "$BUILD_UUID" > out/esp/BUILD_UUID
sudo bash -c "echo '$BUILD_UUID' > out/esp/mount/EFI/PhoenixGuard/ESP_UUID.txt"

sudo bash -c "echo $HASH > out/esp/mount/EFI/PhoenixGuard/NuclearBootEdk2.sha256"

# Create grub.cfg in three locations
GRUBCFG_TMP=$(mktemp)
{
cat <<-GRUBCFG
# PhoenixGuard GRUB configuration (auto-generated)
set timeout=5
set default=0

insmod efi_gop
insmod efi_uga
insmod font
insmod part_gpt
insmod fat
insmod normal
# ISO support
insmod iso9660
insmod loopback

if loadfont unicode; then
  set gfxmode=auto
  set gfxpayload=keep
  terminal_output gfxterm
fi

# Load user overrides if present
if [ -f /EFI/PhoenixGuard/user.cfg ]; then
  configfile /EFI/PhoenixGuard/user.cfg
fi

menuentry "PhoenixGuard [UUID: $BUILD_UUID]: Return to Nuclear Boot" {
  chainloader /EFI/BOOT/BOOTX64.EFI
}
GRUBCFG
if [ -n "$ISO_BASENAME" ]; then
cat <<-GRUBCFG
menuentry "Boot ISO: $ISO_BASENAME (loopback)" {
  set ISO_PATH="/ISO/$ISO_BASENAME"
  if [ -f (hd0)$ISO_PATH ]; then
    set espdev="(hd0)"
  elif [ -f (hd0,msdos1)$ISO_PATH ]; then
    set espdev="(hd0,msdos1)"
  elif [ -f (hd0,gpt1)$ISO_PATH ]; then
    set espdev="(hd0,gpt1)"
  else
    echo "ISO not found: $ISO_PATH"
    sleep 2
    return
  fi
  loopback loop ${espdev}$ISO_PATH
  if [ -f (loop)/casper/vmlinuz ]; then
    linux (loop)/casper/vmlinuz boot=casper iso-scan/filename=$ISO_PATH quiet splash --- $ISO_EXTRA_ARGS
    if [ -f (loop)/casper/initrd ]; then
      initrd (loop)/casper/initrd
    fi
    boot
  elif [ -f (loop)/live/vmlinuz ]; then
    linux (loop)/live/vmlinuz boot=live iso-scan/filename=$ISO_PATH quiet splash --- $ISO_EXTRA_ARGS
    if [ -f (loop)/live/initrd.img ]; then
      initrd (loop)/live/initrd.img
    fi
    boot
  elif [ -f (loop)/boot/vmlinuz ]; then
    linux (loop)/boot/vmlinuz iso-scan/filename=$ISO_PATH quiet splash --- $ISO_EXTRA_ARGS
    if [ -f (loop)/boot/initrd ]; then
      initrd (loop)/boot/initrd
    fi
    boot
  else
    echo "No known kernel found inside ISO"
  fi
}
GRUBCFG
fi
cat <<-'GRUBCFG'
menuentry "UEFI Firmware Settings" {
  fwsetup
}
menuentry "Reboot" {
  reboot
}
GRUBCFG
} > "$GRUBCFG_TMP"

sudo cp "$GRUBCFG_TMP" out/esp/mount/EFI/BOOT/grub.cfg
sudo cp "$GRUBCFG_TMP" out/esp/mount/EFI/PhoenixGuard/grub.cfg
sudo cp "$GRUBCFG_TMP" out/esp/mount/boot/grub/grub.cfg
rm -f "$GRUBCFG_TMP"

# Unmount and finalize
sudo umount out/esp/mount
rmdir out/esp/mount
sha256sum out/esp/esp.img > out/esp/esp.img.sha256

# Record OVMF paths if discovered
if [ -f out/setup/ovmf_code_path ] && [ -f out/setup/ovmf_vars_path ]; then
  OVMF_CODE_PATH=$(cat out/setup/ovmf_code_path)
  OVMF_VARS_PATH=$(cat out/setup/ovmf_vars_path)
  printf '%s\n%s\n' "$OVMF_CODE_PATH" "$OVMF_VARS_PATH" > out/esp/ovmf_paths.txt
  ok "Using discovered OVMF paths: $OVMF_CODE_PATH"
else
  die "OVMF paths not discovered - run 'just setup' first"
fi

ok "ESP image created: out/esp/esp.img"

