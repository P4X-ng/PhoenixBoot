00000000: 2321 2f75 7372 2f62 696e 2f65 6e76 2062  #!/usr/bin/env b
00000010: 6173 680a 7365 7420 2d65 756f 2070 6970  ash.set -euo pip
00000020: 6566 6169 6c0a 2320 4765 6e65 7261 7465  efail.# Generate
00000030: 2063 7573 746f 6d20 504b 2f4b 454b 2f64   custom PK/KEK/d
00000040: 6220 6b65 7973 2061 6e64 2045 534c 2f41  b keys and ESL/A
00000050: 5554 4820 6275 6e64 6c65 7320 666f 7220  UTH bundles for 
00000060: 5365 6375 7265 2042 6f6f 7420 7465 7374  Secure Boot test
00000070: 696e 670a 2320 4f75 7470 7574 2064 6972  ing.# Output dir
00000080: 6563 746f 7279 2069 7320 7468 6520 6669  ectory is the fi
00000090: 7273 7420 6172 6720 6f72 2064 6566 6175  rst arg or defau
000000a0: 6c74 7320 746f 202e 2f73 626b 6579 730a  lts to ./sbkeys.
000000b0: 0a4f 5554 5f44 4952 3d24 7b31 3a2d 7362  .OUT_DIR=${1:-sb
000000c0: 6b65 7973 7d0a 6d6b 6469 7220 2d70 2022  keys}.mkdir -p "
000000d0: 244f 5554 5f44 4952 220a 0a50 4b5f 4b45  $OUT_DIR"..PK_KE
000000e0: 593d 2224 4f55 545f 4449 522f 706b 2e6b  Y="$OUT_DIR/pk.k
000000f0: 6579 220a 504b 5f43 5254 3d22 244f 5554  ey".PK_CRT="$OUT
00000100: 5f44 4952 2f70 6b2e 6372 7422 0a4b 454b  _DIR/pk.crt".KEK
00000110: 5f4b 4559 3d22 244f 5554 5f44 4952 2f6b  _KEY="$OUT_DIR/k
00000120: 656b 2e6b 6579 220a 4b45 4b5f 4352 543d  ek.key".KEK_CRT=
00000130: 2224 4f55 545f 4449 522f 6b65 6b2e 6372  "$OUT_DIR/kek.cr
00000140: 7422 0a44 425f 4b45 593d 2224 4f55 545f  t".DB_KEY="$OUT_
00000150: 4449 522f 6462 2e6b 6579 220a 4442 5f43  DIR/db.key".DB_C
00000160: 5254 3d22 244f 5554 5f44 4952 2f64 622e  RT="$OUT_DIR/db.
00000170: 6372 7422 0a0a 504b 5f45 534c 3d22 244f  crt"..PK_ESL="$O
00000180: 5554 5f44 4952 2f70 6b2e 6573 6c22 0a4b  UT_DIR/pk.esl".K
00000190: 454b 5f45 534c 3d22 244f 5554 5f44 4952  EK_ESL="$OUT_DIR
000001a0: 2f6b 656b 2e65 736c 220a 4442 5f45 534c  /kek.esl".DB_ESL
000001b0: 3d22 244f 5554 5f44 4952 2f64 622e 6573  ="$OUT_DIR/db.es
000001c0: 6c22 0a0a 504b 5f41 5554 483d 2224 4f55  l"..PK_AUTH="$OU
000001d0: 545f 4449 522f 706b 2e61 7574 6822 0a4b  T_DIR/pk.auth".K
000001e0: 454b 5f41 5554 483d 2224 4f55 545f 4449  EK_AUTH="$OUT_DI
000001f0: 522f 6b65 6b2e 6175 7468 220a 4442 5f41  R/kek.auth".DB_A
00000200: 5554 483d 2224 4f55 545f 4449 522f 6462  UTH="$OUT_DIR/db
00000210: 2e61 7574 6822 0a0a 2320 4372 6561 7465  .auth"..# Create
00000220: 2063 6572 7473 2f6b 6579 730a 6f70 656e   certs/keys.open
00000230: 7373 6c20 7265 7120 2d6e 6577 202d 7835  ssl req -new -x5
00000240: 3039 202d 6e65 776b 6579 2072 7361 3a33  09 -newkey rsa:3
00000250: 3037 3220 2d73 6861 3235 3620 2d64 6179  072 -sha256 -day
00000260: 7320 3336 3530 202d 6e6f 6465 7320 5c0a  s 3650 -nodes \.
00000270: 2020 2d73 7562 6a20 222f 434e 3d50 686f    -subj "/CN=Pho
00000280: 656e 6978 4775 6172 6420 504b 2f22 202d  enixGuard PK/" -
00000290: 6b65 796f 7574 2022 2450 4b5f 4b45 5922  keyout "$PK_KEY"
000002a0: 202d 6f75 7420 2224 504b 5f43 5254 220a   -out "$PK_CRT".
000002b0: 6f70 656e 7373 6c20 7265 7120 2d6e 6577  openssl req -new
000002c0: 202d 7835 3039 202d 6e65 776b 6579 2072   -x509 -newkey r
000002d0: 7361 3a33 3037 3220 2d73 6861 3235 3620  sa:3072 -sha256 
000002e0: 2d64 6179 7320 3336 3530 202d 6e6f 6465  -days 3650 -node
000002f0: 7320 5c0a 2020 2d73 7562 6a20 222f 434e  s \.  -subj "/CN
00000300: 3d50 686f 656e 6978 4775 6172 6420 4b45  =PhoenixGuard KE
00000310: 4b2f 2220 2d6b 6579 6f75 7420 2224 4b45  K/" -keyout "$KE
00000320: 4b5f 4b45 5922 202d 6f75 7420 2224 4b45  K_KEY" -out "$KE
00000330: 4b5f 4352 5422 0a6f 7065 6e73 736c 2072  K_CRT".openssl r
00000340: 6571 202d 6e65 7720 2d78 3530 3920 2d6e  eq -new -x509 -n
00000350: 6577 6b65 7920 7273 613a 3330 3732 202d  ewkey rsa:3072 -
00000360: 7368 6132 3536 202d 6461 7973 2033 3635  sha256 -days 365
00000370: 3020 2d6e 6f64 6573 205c 0a20 202d 7375  0 -nodes \.  -su
00000380: 626a 2022 2f43 4e3d 5068 6f65 6e69 7847  bj "/CN=PhoenixG
00000390: 7561 7264 2064 622f 2220 2d6b 6579 6f75  uard db/" -keyou
000003a0: 7420 2224 4442 5f4b 4559 2220 2d6f 7574  t "$DB_KEY" -out
000003b0: 2022 2444 425f 4352 5422 0a0a 2320 4553   "$DB_CRT"..# ES
000003c0: 4c73 2069 6620 746f 6f6c 7320 6172 6520  Ls if tools are 
000003d0: 7072 6573 656e 740a 6966 2063 6f6d 6d61  present.if comma
000003e0: 6e64 202d 7620 6365 7274 2d74 6f2d 6566  nd -v cert-to-ef
000003f0: 692d 7369 672d 6c69 7374 203e 2f64 6576  i-sig-list >/dev
00000400: 2f6e 756c 6c20 323e 2631 3b20 7468 656e  /null 2>&1; then
00000410: 0a20 2063 6572 742d 746f 2d65 6669 2d73  .  cert-to-efi-s
00000420: 6967 2d6c 6973 7420 2d67 2030 3030 3030  ig-list -g 00000
00000430: 3030 302d 3030 3030 2d30 3030 302d 3030  000-0000-0000-00
00000440: 3030 2d30 3030 3030 3030 3030 3030 3020  00-000000000000 
00000450: 2224 504b 5f43 5254 2220 2224 504b 5f45  "$PK_CRT" "$PK_E
00000460: 534c 220a 2020 6365 7274 2d74 6f2d 6566  SL".  cert-to-ef
00000470: 692d 7369 672d 6c69 7374 202d 6720 3030  i-sig-list -g 00
00000480: 3030 3030 3030 2d30 3030 302d 3030 3030  000000-0000-0000
00000490: 2d30 3030 302d 3030 3030 3030 3030 3030  -0000-0000000000
000004a0: 3030 2022 244b 454b 5f43 5254 2220 2224  00 "$KEK_CRT" "$
000004b0: 4b45 4b5f 4553 4c22 0a20 2063 6572 742d  KEK_ESL".  cert-
000004c0: 746f 2d65 6669 2d73 6967 2d6c 6973 7420  to-efi-sig-list 
000004d0: 2d67 2030 3030 3030 3030 302d 3030 3030  -g 00000000-0000
000004e0: 2d30 3030 302d 3030 3030 2d30 3030 3030  -0000-0000-00000
000004f0: 3030 3030 3030 3020 2224 4442 5f43 5254  0000000 "$DB_CRT
00000500: 2220 2224 4442 5f45 534c 220a 6669 0a0a  " "$DB_ESL".fi..
00000510: 2320 4155 5448 7320 6966 2074 6f6f 6c73  # AUTHs if tools
00000520: 2061 7265 2070 7265 7365 6e74 0a69 6620   are present.if 
00000530: 636f 6d6d 616e 6420 2d76 2073 6967 6e2d  command -v sign-
00000540: 6566 692d 7369 672d 6c69 7374 203e 2f64  efi-sig-list >/d
00000550: 6576 2f6e 756c 6c20 323e 2631 3b20 7468  ev/null 2>&1; th
00000560: 656e 0a20 2023 2050 4b20 7369 676e 7320  en.  # PK signs 
00000570: 6974 7365 6c66 0a20 2073 6967 6e2d 6566  itself.  sign-ef
00000580: 692d 7369 672d 6c69 7374 202d 6320 2224  i-sig-list -c "$
00000590: 504b 5f43 5254 2220 2d6b 2022 2450 4b5f  PK_CRT" -k "$PK_
000005a0: 4b45 5922 2050 4b20 2224 504b 5f45 534c  KEY" PK "$PK_ESL
000005b0: 2220 2224 504b 5f41 5554 4822 0a20 2023  " "$PK_AUTH".  #
000005c0: 204b 454b 2061 7574 686f 7269 7a65 6420   KEK authorized 
000005d0: 6279 2050 4b0a 2020 7369 676e 2d65 6669  by PK.  sign-efi
000005e0: 2d73 6967 2d6c 6973 7420 2d63 2022 2450  -sig-list -c "$P
000005f0: 4b5f 4352 5422 202d 6b20 2224 504b 5f4b  K_CRT" -k "$PK_K
00000600: 4559 2220 4b45 4b20 2224 4b45 4b5f 4553  EY" KEK "$KEK_ES
00000610: 4c22 2022 244b 454b 5f41 5554 4822 0a20  L" "$KEK_AUTH". 
00000620: 2023 2064 6220 6175 7468 6f72 697a 6564   # db authorized
00000630: 2062 7920 4b45 4b0a 2020 7369 676e 2d65   by KEK.  sign-e
00000640: 6669 2d73 6967 2d6c 6973 7420 2d63 2022  fi-sig-list -c "
00000650: 244b 454b 5f43 5254 2220 2d6b 2022 244b  $KEK_CRT" -k "$K
00000660: 454b 5f4b 4559 2220 6462 2022 2444 425f  EK_KEY" db "$DB_
00000670: 4553 4c22 2022 2444 425f 4155 5448 220a  ESL" "$DB_AUTH".
00000680: 6669 0a0a 6563 686f 2022 5b73 622d 6b65  fi..echo "[sb-ke
00000690: 7973 2d63 7573 746f 6d5d 2047 656e 6572  ys-custom] Gener
000006a0: 6174 6564 206b 6579 7320 696e 2024 4f55  ated keys in $OU
000006b0: 545f 4449 5222 0a                        T_DIR".
